!function(t){var e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=546)}({546:function(t,e,i){"use strict";function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function o(t,e){return!e||"object"!==n(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function s(t,e,i){return(s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var n=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=a(t)););return t}(t,e);if(n){var r=Object.getOwnPropertyDescriptor(n,e);return r.get?r.get.call(i):r.value}})(t,e,i||t)}function a(t){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function u(t,e){return(u=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}i.r(e);var c=function(t){function e(t){var i;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n=new RK.PlaneBufferGeometry(99999,99999,1,1),r=new SK.Basic({color:new RK.Vec3(255,0,0),wireframe:!0,depthTest:!1,depthWrite:!0,side:RK.DoubleSide});return r.visible=!1,(i=o(this,a(e).call(this,n,r))).unitX=new RK.Vec3(1,0,0),i.unitY=new RK.Vec3(0,1,0),i.unitZ=new RK.Vec3(0,0,1),i.tempVector=new RK.Vec3,i.dirVector=new RK.Vec3,i.alignVector=new RK.Vec3,i.tempMatrix=new RK.Matrix4,i.identityQuaternion=new RK.Quaternion,i.transformer=t,i}var i,n,c;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&u(t,e)}(e,RK.Mesh),i=e,(n=[{key:"updateMatrixWorld",value:function(t){var i=this.transformer.mode,n=this.transformer.local;switch(this.position.copy(this.transformer.worldPosition),this.unitX.set(1,0,0).applyQuaternion(n?this.transformer.worldQuaternion:this.identityQuaternion),this.unitY.set(0,1,0).applyQuaternion(n?this.transformer.worldQuaternion:this.identityQuaternion),this.unitZ.set(0,0,1).applyQuaternion(n?this.transformer.worldQuaternion:this.identityQuaternion),this.alignVector.copy(this.unitY),i){case"translate":case"scale":switch(this.transformer.axis){case"X":this.alignVector.copy(this.transformer.eye).cross(this.unitX),this.dirVector.copy(this.unitX).cross(this.alignVector);break;case"Y":this.alignVector.copy(this.transformer.eye).cross(this.unitY),this.dirVector.copy(this.unitY).cross(this.alignVector);break;case"Z":this.alignVector.copy(this.transformer.eye).cross(this.unitZ),this.dirVector.copy(this.unitZ).cross(this.alignVector);break;case"XY":this.dirVector.copy(this.unitZ);break;case"YZ":this.dirVector.copy(this.unitX);break;case"XZ":this.alignVector.copy(this.unitZ),this.dirVector.copy(this.unitY);break;case"XYZ":case"E":this.dirVector.set(0,0,0)}break;case"rotate":default:this.dirVector.set(0,0,0)}this.dirVector.negate(),0===this.dirVector.length()?this.quaternion.copy(this.transformer.cameraQuaternion):(this.tempMatrix.lookAt(this.tempVector.set(0,0,0),this.dirVector,this.alignVector),this.quaternion.setFromRotationMatrix(this.tempMatrix)),s(a(e.prototype),"updateMatrixWorld",this).call(this,t)}}])&&r(i.prototype,n),c&&r(i,c),e}();function h(t){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function l(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t))&&"[object Arguments]"!==Object.prototype.toString.call(t))return;var i=[],n=!0,r=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done)&&(i.push(s.value),!e||i.length!==e);n=!0);}catch(t){r=!0,o=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw o}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function p(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function f(t,e){return!e||"object"!==h(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function w(t){return(w=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function d(t,e){return(d=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var y=new RK.Vec3(.6,0,0),m=new RK.Vec3(1,0,0),v=function(t){function e(t){var i;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(i=f(this,w(e).call(this))).transformer=t,i.collision=[],i.shaftLength=.4,i.shaftRadius=.016,i.centerRadius=.045,i.makeCollision(),i.make(),i.make(!0),i}var i,n,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&d(t,e)}(e,RK.Object3D),i=e,r=[{key:"getInvisibleMat",value:function(){return e._matInvisible||(e._matInvisible=new SK.Basic({color:new RK.Vec3(1,0,1),depthTest:!0,depthWrite:!0})),e._matInvisible.visible=!1,e._matInvisible}},{key:"getStandardMat",value:function(){return new SK.Basic({color:y,depthTest:!0,depthWrite:!0,opacity:1})}},{key:"getObscuredMat",value:function(){var t=new SK.Basic({color:y,depthTest:!1,depthWrite:!0,opacity:.4});return t.transparent=!0,t}}],(n=[{key:"makeCollision",value:function(){var t=this.shaftLength+.15,i=new RK.CylinderBufferGeometry(.15,0,t,6,1,!1),n=e.getInvisibleMat(),r=new RK.Mesh(i,n);r.position.set(t/2,0,0),r.rotation.set(0,0,-Math.PI/2),r.name="X";var o=new RK.Mesh(i,n);o.position.set(0,t/2,0),o.name="Y";var s=new RK.Mesh(i,n);s.position.set(0,0,t/2),s.rotation.set(Math.PI/2,0,0),s.name="Z";var a=new RK.Mesh(new RK.SphereBufferGeometry(1.5*this.centerRadius,8,6),n);a.name="XYZ",a.isCenterHandle=!0,this.collision.push(r,o,s,a),this.add(r,o,s,a)}},{key:"makeShaftGeo",value:function(){var t=this.shaftRadius,e=this.shaftLength-this.centerRadius;return new RK.CylinderBufferGeometry(t,t,e,12,1,!1)}},{key:"make",value:function(t){var i=this,n=l(this.makeArrowGeo(),2),r=n[0],o=n[1],s=this.makeShaftGeo(),a=function(n){var a=t?e.getObscuredMat():e.getStandardMat(),u=new RK.Mesh(r,a);u.position.copy(o),u.name=n,u.isHandle=!0;var c=new RK.Mesh(s,a);c.position.set(0,(i.shaftLength+i.centerRadius)/2,0),c.name=n;var h=new RK.Object3D;return h.add(u,c),[h,a]},u=l(a("X"),2),c=u[0],h=u[1];c.rotation.set(0,0,-Math.PI/2);var p=l(a("Y"),2),f=p[0],w=p[1],d=l(a("Z"),2),y=d[0],m=d[1];y.rotation.set(Math.PI/2,0,0);var v=t?e.getObscuredMat():e.getStandardMat(),g=new RK.Mesh(this.makeCenterGeo(),v);g.name="XYZ",g.isHandle=!0,t?(this.axisMaterialsObscured={X:h,Y:w,Z:m,XYZ:v},this.collision.push(c,f,y,g)):this.axisMaterials={X:h,Y:w,Z:m,XYZ:v},this.add(c,f,y,g)}},{key:"hoverOverAxis",value:function(t){for(var e in this.axisMaterials){var i=e===t||t&&2===t.length&&t.includes(e);this.axisMaterials[e].setUniform("color",i?m:y)}for(var n in this.axisMaterialsObscured){var r=n===t||t&&2===t.length&&t.includes(n);this.axisMaterialsObscured[n].setUniform("color",r?m:y),this.axisMaterialsObscured[n].setUniform("opacity",r?.6:.4)}}},{key:"intersect",value:function(t){var e=t.intersectObjects(this.collision,!0);return e.find((function(t){return t.object.isHandle}))||e.find((function(t){return t.object.visible}))||e.find((function(t){return"XYZ"===t.object.name}))||e[0]}},{key:"refresh",value:function(){}}])&&p(i.prototype,n),r&&p(i,r),e}();function g(t){return(g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function b(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function S(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function R(t,e){return!e||"object"!==g(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function K(t){return(K=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function M(t,e){return(M=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var O=function(t){function e(){return b(this,e),R(this,K(e).apply(this,arguments))}var i,n,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&M(t,e)}(e,t),i=e,(n=[{key:"makeArrowGeo",value:function(){return[new RK.CylinderBufferGeometry(0,.04,.1,12,1,!1),new RK.Vec3(0,this.shaftLength+.05,0)]}},{key:"makeCenterGeo",value:function(){var t=this.centerRadius+.02;return new RK.OctahedronBufferGeometry(t)}}])&&S(i.prototype,n),r&&S(i,r),e}(v);function k(t){return(k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function j(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function T(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function P(t,e){return!e||"object"!==k(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function x(t){return(x=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function Q(t,e){return(Q=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var C=function(t){function e(){return j(this,e),P(this,x(e).apply(this,arguments))}var i,n,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Q(t,e)}(e,t),i=e,(n=[{key:"makeArrowGeo",value:function(){return[new RK.CylinderBufferGeometry(.05,.05,.035,16,1,!1),new RK.Vec3(0,this.shaftLength+.0175,0)]}},{key:"makeCenterGeo",value:function(){var t=this.centerRadius+.005;return new RK.SphereBufferGeometry(t,16,12)}}])&&T(i.prototype,n),r&&T(i,r),e}(v);function z(t){return(z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function E(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function V(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _(t,e){return!e||"object"!==z(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function L(t){return(L=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function I(t,e){return(I=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var G=function(t){function e(){return E(this,e),_(this,L(e).apply(this,arguments))}var i,n,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&I(t,e)}(e,t),i=e,(n=[{key:"makeArrowGeo",value:function(){return[new RK.BoxBufferGeometry(.07,.07,.07,1,1,1),new RK.Vec3(0,this.shaftLength+.035,0)]}},{key:"makeCenterGeo",value:function(){var t=2*this.centerRadius;return new RK.BoxBufferGeometry(t,t,t,1,1,1)}}])&&V(i.prototype,n),r&&V(i,r),e}(v);function A(t){return(A="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function D(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t))&&"[object Arguments]"!==Object.prototype.toString.call(t))return;var i=[],n=!0,r=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done)&&(i.push(s.value),!e||i.length!==e);n=!0);}catch(t){r=!0,o=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw o}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function q(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function X(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function B(t,e){return!e||"object"!==A(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function Y(t){return(Y=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function Z(t,e){return(Z=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var H=new RK.Vec3(.6,0,0),U=new RK.Vec3(1,0,0),F=function(t){function e(){return q(this,e),B(this,Y(e).apply(this,arguments))}var i,n,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Z(t,e)}(e,t),i=e,(n=[{key:"makeCollision",value:function(){this._init();var t=v.getInvisibleMat(),e=new RK.CylinderBufferGeometry(1,1,1,6,1,!1),i=new RK.Mesh(e,t);i.name="twist",i.rotation.z=-.5*Math.PI,i.scale.x=3*this.torusRadius,i.scale.y=10*this.shaftRadius,i.scale.z=3*this.torusRadius,this.twistGroup.add(i);var n=new RK.Mesh(e,t);n.name="X",n.position.x=this.shaftLength,n.rotation.z=-.5*Math.PI,n.scale.x=7*this.shaftRadius,n.scale.y=10*this.shaftRadius,n.scale.z=7*this.shaftRadius,this.swingGroup.add(n),this.touchCollision.push(i,n),this.touchCollisionSwing.push(n),this.touchCollisionTwist.push(i),this.touchTwist=i,this.touchSwing=n}},{key:"makeShaftGeo",value:function(){var t=this.shaftRadius,e=this.shaftLength-this.centerRadius;return new RK.CylinderBufferGeometry(t,t,e,12,1,!1)}},{key:"make",value:function(t){var e=this;this._init();var i=D(this.makeArrowGeo(),2),n=i[0],r=i[1],o=this.makeShaftGeo(),s=D(function(i){var s=t?v.getObscuredMat():v.getStandardMat(),a=new RK.Mesh(n,s);a.position.copy(r),a.name=i,a.isHandle=!0;var u=new RK.Mesh(o,s);u.position.set(0,(e.shaftLength+e.centerRadius)/2,0),u.name=i;var c=new RK.Object3D;return c.add(a,u),[c,s]}("X"),2),a=s[0],u=s[1];a.rotation.set(0,0,-Math.PI/2),this.swingGroup.add(a);var c=D(this.makeTwist(t),2),h=c[0],l=c[1];this.twistGroup.add(h);var p=this.makeTwistMin(l);this.twistMinGroup.add(p);var f=this.makeTwistMax(l);this.twistMaxGroup.add(f),t?(this.axisMaterialsObscured={X:u,twist:l},this.collision.push(a),this.collision.push(h),this.collisionSwing.push(a),this.collisionTwist.push(h)):this.axisMaterials={X:u,twist:l}}},{key:"hoverOverAxis",value:function(t){for(var e in this.axisMaterials){var i=e===t||t&&2===t.length&&t.includes(e);this.axisMaterials[e].setUniform("color",i?U:H)}for(var n in this.axisMaterialsObscured){var r=n===t||t&&2===t.length&&t.includes(n);this.axisMaterialsObscured[n].setUniform("color",r?U:H),this.axisMaterialsObscured[n].setUniform("opacity",r?.6:.4)}}},{key:"intersect",value:function(t,e){var i=[];e?this.showSwing?i=this.showTwist?this.touchCollision:this.touchCollisionSwing:this.showTwist&&(i=this.touchCollisionTwist):this.showSwing?i=this.showTwist?this.collision:this.collisionSwing:this.showTwist&&(i=this.collisionTwist);var n=t.intersectObjects(i,!0);return n.find((function(t){return t.object.isHandle}))||n.find((function(t){return t.object.visible}))||n.find((function(t){return"XYZ"===t.object.name}))||n[0]}},{key:"makeArrowGeo",value:function(){return[new RK.SphereBufferGeometry(.04,12,12),new RK.Vec3(0,this.shaftLength,0)]}},{key:"makeCenterGeo",value:function(){var t=this.centerRadius+.02;return new RK.OctahedronBufferGeometry(t)}},{key:"makeTwist",value:function(t){var e=t?v.getObscuredMat():v.getStandardMat(),i=new RK.TorusBufferGeometry(this.torusRadius,this.shaftRadius,10,100,1.5*Math.PI),n=new RK.Mesh(i,e);n.rotation.set(0,Math.PI/2,0),n.isHandle=!0,n.name="twist";var r=new RK.CircleBufferGeometry(this.shaftRadius,10),o=new RK.Mesh(r,e);o.name="twistCap0",o.position.y=-this.torusRadius,o.rotation.x=Math.PI,o.rotation.z=Math.PI/10;var s=new RK.Mesh(r,e);s.name="twistCap1",s.position.z=-this.torusRadius,s.rotation.x=Math.PI/2,s.rotation.z=Math.PI/10;var a=new RK.Object3D;return a.name="twistGroup",a.add(n,o,s),[a,e]}},{key:"makeTwistMin",value:function(t){var e=new RK.CylinderBufferGeometry(0,2*this.shaftRadius,4*this.shaftRadius,12,1,!1),i=new RK.Mesh(e,t);return i.position.set(0,0,-this.torusRadius),i.rotation.set(Math.PI,0,0),i.name="twistMax",i}},{key:"makeTwistMax",value:function(t){var e=new RK.CylinderBufferGeometry(0,2*this.shaftRadius,4*this.shaftRadius,12,1,!1),i=new RK.Mesh(e,t);return i.position.set(0,-this.torusRadius,0),i.rotation.set(-Math.PI/2,0,0),i.name="twistMin",i}},{key:"refresh",value:function(){if("twistswing"===this.order){var t=(new RK.Quaternion).multiplyQuaternions(this.parentQuaternion.clone().inverse(),this.quaternion),e=(new RK.SwingTwist).setFromQuaternion(t,this.order);this.twistGroup.quaternion.copy(t),this.twistGroup.quaternion.x*=this.parentScale.x,this.twistGroup.quaternion.w*=this.parentScale.x,this.twistGroup.quaternion.inverse().multiply(e.twist).multiply(this.orient),this.twistGroup.scale.copy(this.parentScale),this.swingGroup.quaternion.copy(this.orient),this.group.quaternion.set(0,0,0,1)}else this.twistGroup.quaternion.copy(new RK.Quaternion),this.swingGroup.quaternion.copy(new RK.Quaternion),this.group.quaternion.copy(this.orient),this.group.quaternion.x*=this.parentScale.x,this.group.quaternion.w*=this.parentScale.x;this.group.scale.set(this.gizmoScale,this.gizmoScale,this.gizmoScale).multiply(this.parentScale),this.group.updateMatrix(),this.group.updateMatrixWorld(),this.updateMatrix(),this.updateMatrixWorld(),this.twistGroup.visible=this.showTwist,this.swingGroup.visible=this.showSwing}},{key:"_init",value:function(){this.touchCollision||(this.collisionSwing=[],this.collisionTwist=[],this.touchCollision=[],this.touchCollisionSwing=[],this.touchCollisionTwist=[],this.torusRadius=this.shaftLength/4),void 0===this.group&&(this.group=new RK.Object3D,this.swingGroup=new RK.Object3D,this.twistGroup=new RK.Object3D,this.twistMinGroup=new RK.Object3D,this.twistMaxGroup=new RK.Object3D,this.twistGroup.add(this.twistMinGroup,this.twistMaxGroup),this.group.add(this.swingGroup,this.twistGroup),this.order="twistswing",this.parentQuaternion=new RK.Quaternion,this.parentScale=new RK.Vec3(1,1,1),this.postRotate=new RK.Quaternion,this.orient=new RK.Quaternion,this.gizmoScale=1,this.add(this.group)),void 0===this.showTwist&&(this.showTwist=!0,this.showSwing=!0)}},{key:"gizmoScale",get:function(){return this._gizmoScale},set:function(t){this._gizmoScale=t,this.refresh()}},{key:"showTwistMin",get:function(){return this.twistMinGroup.visible},set:function(t){this.twistMinGroup.visible=t}},{key:"showTwistMax",get:function(){return this.twistMaxGroup.visible},set:function(t){this.twistMaxGroup.visible=t}}])&&X(i.prototype,n),r&&X(i,r),e}(v);function W(t){return(W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function J(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}function N(t,e,i){return(N=J()?Reflect.construct:function(t,e,i){var n=[null];n.push.apply(n,e);var r=new(Function.bind.apply(t,n));return i&&nt(r,i.prototype),r}).apply(null,arguments)}function $(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function tt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function et(t){return(et=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function it(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function nt(t,e){return(nt=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var rt=function(t){function e(t,i){var n,r,o;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),r=this,o=et(e).call(this),(n=!o||"object"!==W(o)&&"function"!=typeof o?it(r):o).domElement=i,n.camera=t,n.ray=new RK.Raycaster,n.gizmos={translate:new O(it(n)),rotate:new C(it(n)),scale:new G(it(n)),swingTwist:new F(it(n))},n.helperPlane=new c(it(n)),n.add(n.gizmos.translate,n.gizmos.rotate,n.gizmos.scale,n.gizmos.swingTwist,n.helperPlane),n.setMode("translate"),n.setSpace("local");var s=!1;return n.pointerDown=function(t){s?t.preventDefault():n.onPointerDown(t)},n.pointerMove=function(t){return n.onPointerMove(t)},n.pointerHover=function(t){s||n.onPointerHover(t)},n.pointerUp=function(t){n.onPointerUp(t),s=!1},n.cameraMoved=function(t){return n.onCameraMoved()},n.screenResized=function(t){return n.onScreenResized()},n.touchStart=function(t){s=!0,n.onPointerDown(t,!0)},i.addEventListener("mousedown",n.pointerDown,!1),i.addEventListener("mousemove",n.pointerHover,!1),document.addEventListener("mouseup",n.pointerUp,!1),i.addEventListener("touchstart",n.touchStart,!1),i.addEventListener("touchmove",n.pointerMove,!1),i.addEventListener("touchend",n.pointerUp,!1),i.addEventListener("touchcancel",n.pointerUp,!1),i.addEventListener("touchleave",n.pointerUp,!1),CK.Events.on("cameraMoved",n.cameraMoved),CK.Events.on("resize",n.screenResized),n.identityQuaternion=new RK.Quaternion,n.pointStart=new RK.Vec3,n.pointEnd=new RK.Vec3,n.rotationAxis=new RK.Vec3,n.rotationAngle=0,n.parentPosition=new RK.Vec3,n.parentQuaternion=new RK.Quaternion,n.parentScale=new RK.Vec3,n.worldPosition=new RK.Vec3,n.worldQuaternion=new RK.Quaternion,n.worldScale=new RK.Vec3,n.cameraPosition=new RK.Vec3,n.cameraQuaternion=new RK.Quaternion,n.cameraScale=new RK.Vec3,n.positionStart=new RK.Vec3,n.quaternionStart=new RK.Quaternion,n.scaleStart=new RK.Vec3,n.worldPositionStart=new RK.Vec3,n.worldQuaternionStart=new RK.Quaternion,n.worldScaleStart=new RK.Vec3,n.bindQuaternion=new RK.Quaternion,n.bindQuaternionInverse=new RK.Quaternion,n.eye=new RK.Vec3,n.visible=!1,n}var i,n,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&nt(t,e)}(e,RK.Object3D),i=e,(n=[{key:"dispose",value:function(){domElement.removeEventListener("mousedown",this.pointerDown,!1),domElement.removeEventListener("mousemove",this.pointerHover,!1),document.removeEventListener("mouseup",this.pointerUp,!1),domElement.removeEventListener("touchstart",this.touchStart,!1),domElement.removeEventListener("touchmove",this.pointerMove,!1),domElement.removeEventListener("touchend",this.pointerUp,!1),domElement.removeEventListener("touchcancel",this.pointerUp,!1),domElement.removeEventListener("touchleave",this.pointerUp,!1),CK.Events.off("cameraMoved",this.cameraMoved),CK.Events.off("resize",this.screenResized)}},{key:"setMode",value:function(t){this.gizmo=this.gizmos[t]||console.error("Invalid mode",t),this.mode=t,this.refresh()}},{key:"setSpace",value:function(t){this.space=t,this.refresh()}},{key:"refresh",value:function(){var t=this;if(this.object&&this.object.parent){if(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(this.parentPosition,this.parentQuaternion,this.parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this.worldScale),this.bindQuaternion.fromArray(this.object.poses.rot).normalize(),this.bindQuaternionInverse.copy(this.bindQuaternion).inverse(),["translate","scale","rotate","swingTwist"].map((function(e){t.gizmos[e].visible=t.mode===e})),this.gizmo.quaternion.copy(this.local?this.worldQuaternion:this.identityQuaternion),this.gizmo.position.copy(this.worldPosition),"swingTwist"===this.mode){this.gizmo.parentQuaternion.copy(this.parentQuaternion),this.gizmo.parentScale.copy(this.parentScale),this.gizmo.postRotate.copy(this.bindQuaternion),this.gizmo.orient=this.gizmoOrient,this.gizmo.order=this.swingTwistLimits.order,this.gizmo.showTwist=this.swingTwistLimits.x[0]<this.swingTwistLimits.x[1],this.gizmo.showSwing=this.swingTwistLimits.y[0]<this.swingTwistLimits.y[1]||this.swingTwistLimits.z[0]<this.swingTwistLimits.z[1];var e=this.swingTwistLimits.x[0],i=this.swingTwistLimits.x[1],n=!0,r=!0;if(e<i&&i-e<1.95*Math.PI){var o=this.twist;n=Math.abs(o-e)>.01,r=Math.abs(o-i)>.01}this.gizmo.showTwistMin=n,this.gizmo.showTwistMax=r}this.updateGizmoScale(),this.gizmo.refresh(),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this.cameraScale),this.camera instanceof RK.PerspectiveCamera?this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize():this.camera instanceof RK.OrthographicCamera&&this.eye.copy(this.cameraPosition).normalize(),CK.GameLoop.requestAnimationRefresh()}}},{key:"attach",value:function(t,i){if(t){if(this.object=t,this.visible=!0,this.coneConstraint=null,this.swingTwistLimits=EX.Kit.coneLimit||e.defaultLimits,this.gizmoOrient=new RK.Quaternion,this.object.isBone){var n=HF.JointLimits.limits;if(n){var r=n[i];if(r){var o=r[t.boneID];if(o){var s=o.cone;s&&(this.swingTwistLimits=s)}}}}this.coneConstraint=new RK.ConeConstraint(this.swingTwistLimits.x[0],this.swingTwistLimits.x[1],this.swingTwistLimits.y[0],this.swingTwistLimits.y[1],this.swingTwistLimits.z[0],this.swingTwistLimits.z[1],this.swingTwistLimits.order||"swingtwist"),this.coneConstraint.bind.fromArray(this.object.poses.rot),this.swingTwistLimits.orient&&(this.gizmoOrient.copy(this.swingTwistLimits.orient),this.coneConstraint.orient.copy(this.swingTwistLimits.orient)),this.swingTwistLimits.preRotate&&this.coneConstraint.preRotate.copy(this.swingTwistLimits.preRotate),this.refresh()}else this.detach();this.initSwingTwist()}},{key:"detach",value:function(){this.object=void 0,this.visible=!1,this.refresh()}},{key:"initSwingTwist",value:function(){if("swingTwist"===this.mode){var t=(this.swingTwistLimits||{}).order;this.gizmoOrientInverse=this.gizmoOrient.clone().inverse(),this.preRotate=new RK.Quaternion,this.swingTwistLimits.preRotate&&this.preRotate.copy(this.swingTwistLimits.preRotate),this.preRotateInverse=(new RK.Quaternion).copy(this.preRotate).inverse();var e=this.gizmoOrientInverse.clone().multiply(this.bindQuaternionInverse).multiply(this.object.quaternion).multiply(this.preRotateInverse).multiply(this.gizmoOrient),i=(new RK.SwingTwist).setFromQuaternion(e,t);this.twist=2*Math.acos(i.twist.w)*Math.sign(i.twist.x)}}},{key:"onPointerDown",value:function(t,e){t.preventDefault();var i=this.getPointer(t),n=this.onPointerHover(t,e);if(n&&void 0!==this.object&&!0!==this.dragging&&(void 0===i.button||0===i.button)&&null!==this.axis){var r=this.ray.intersectObjects([this.helperPlane],!0)[0];if(r){if(document.addEventListener("mousemove",this.pointerMove,!1),this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this.positionStart.copy(this.object.position),this.quaternionStart.copy(this.object.quaternion),this.scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this.worldScaleStart),this.pointStart.copy(r.point).sub(this.worldPositionStart),this.local&&this.pointStart.applyQuaternion(this.worldQuaternionStart.clone().inverse()),"swingTwist"===this.mode){var o=(this.swingTwistLimits||{}).order;this.gizmoOrientInverse=this.gizmoOrient.clone().inverse(),this.preRotate=new RK.Quaternion,this.swingTwistLimits.preRotate&&this.preRotate.copy(this.swingTwistLimits.preRotate),this.preRotateInverse=(new RK.Quaternion).copy(this.preRotate).inverse();var s=this.gizmoOrientInverse.clone().multiply(this.bindQuaternionInverse).multiply(this.quaternionStart).multiply(this.preRotateInverse).multiply(this.gizmoOrient);this.swingTwistStart=(new RK.SwingTwist).setFromQuaternion(s,o),this.swingTwist=this.swingTwistStart.clone(),this.clickPointStart=new RK.Vec3,this.clickPointStart.copy(n.point).sub(this.worldPositionStart);var a=this.clickPointStart.length();if("X"===this.axis){var u=.025*a;this.pointZScale=Math.sign(this.eye.dot(this.clickPointStart)+u)||1,this.swingSpaceQuaternion=this.bindQuaternion.clone(),this.swingSpaceQuaternion.multiply(this.gizmoOrient),"twistswing"===o&&this.swingSpaceQuaternion.multiply(this.swingTwistStart.twist)}else if("twist"===this.axis){this.twistSpaceQuaternion=this.bindQuaternion.clone(),this.twistSpaceQuaternion.multiply(this.gizmoOrient),"swingtwist"===o&&this.twistSpaceQuaternion.multiply(this.swingTwistStart.swing);var c=new RK.Vec3(1,0,0);c.applyQuaternion(this.twistSpaceQuaternion).multiply(this.parentScale).applyQuaternion(this.parentQuaternion);var h=this.ray.ray.direction.clone(),l=c.dot(h),p=.47*Math.PI,f=Math.cos(p),w=.25*Math.PI,d=Math.cos(w);if(this.twistPlaneClamp=new RK.Quaternion,this.twistSideOn=!1,Math.abs(l)<f){this.twistSideOn=!0,this.radiusStart=a;var y=h,m=c,v=h.clone().cross(c),g=(new RK.Matrix4).makeBasis(y,m,v);this.twistSpaceQuaternion.setFromRotationMatrix(g)}else if(Math.abs(l)<d){l<0&&(h=h.clone().multiplyScalar(-1),l*=-1);var b=Math.acos(Math.min(Math.max(l,-1),1));c.applyQuaternion(this.parentQuaternion.clone().inverse()).multiply(this.parentScale),h.applyQuaternion(this.parentQuaternion.clone().inverse()).multiply(this.parentScale);var S=(new RK.Quaternion).setFromUnitVectors(c,h),R=1-w/b,K=new RK.Quaternion;S.slerp(K,R),this.twistPlaneClamp.copy(S),this.twistSpaceQuaternion.multiplyQuaternions(this.twistPlaneClamp,this.twistSpaceQuaternion)}this.twistRayHitStart=this._getTwistRayHit(),this.twistRayHit1=this.twistRayHitStart.clone(),this.twist=2*Math.acos(this.swingTwistStart.twist.w)*Math.sign(this.swingTwistStart.twist.x)}}this.dragging=!0,this.dispatchEvent({type:"dragging-changed",value:!0})}}}},{key:"onPointerHover",value:function(t,e){var i=this.getPointer(t);if(void 0!==this.object&&!0!==this.dragging){this.ray.setFromCamera(i,this.camera);var n=i.isTouch||e,r=this.gizmo.intersect(this.ray,n),o=null;return(o=r?r.object.name:null)&&t.ctrlKey&&1===o.length&&"rotate"!==this.mode&&"swingTwist"!==this.mode&&(o={X:"YZ",Y:"XZ",Z:"XY"}[o]),o!==this.axis&&(this.axis=o,this.gizmo.hoverOverAxis(this.axis),this.refresh()),r}}},{key:"onPointerMove",value:function(t){var e=this.axis,i=this.mode,n=this.object,r=this.getPointer(t),o=this.local;if(n&&e&&this.dragging&&(void 0===r.button||0===r.button)){this.ray.setFromCamera(r,this.camera);var s=this.ray.intersectObjects([this.helperPlane],!0)[0];if(s){if(this.pointEnd.copy(s.point).sub(this.worldPositionStart),o&&this.pointEnd.applyQuaternion(this.worldQuaternionStart.clone().inverse()),"translate"===i)-1===e.search("X")&&(this.pointEnd.x=this.pointStart.x),-1===e.search("Y")&&(this.pointEnd.y=this.pointStart.y),-1===e.search("Z")&&(this.pointEnd.z=this.pointStart.z),o?n.position.copy(this.pointEnd).sub(this.pointStart).applyQuaternion(this.quaternionStart):n.position.copy(this.pointEnd).sub(this.pointStart),n.position.add(this.positionStart);else if("scale"===i){var a=new RK.Vec3;if("XYZ"===e){var u=this.pointEnd.clone().sub(this.pointStart),c=1+u.x+u.y;a.set(c,c,c)}else a.copy(this.pointEnd).divide(this.pointStart),-1===e.search("X")&&(a.x=1),-1===e.search("Y")&&(a.y=1),-1===e.search("Z")&&(a.z=1);n.scale.copy(this.scaleStart).multiply(a)}else if("rotate"===i){var h=o?this.worldQuaternion:this.identityQuaternion,l=new RK.Vec3;if("XYZ"===e)l.copy(this.pointEnd).sub(this.pointStart).cross(this.eye).normalize(),this.rotationAxis.copy(l),this.rotationAngle=1*this.pointEnd.sub(this.pointStart).dot(l.cross(this.eye));else if("X"===e||"Y"===e||"Z"===e){var p={X:new RK.Vec3(1,0,0),Y:new RK.Vec3(0,1,0),Z:new RK.Vec3(0,0,1)}[e],f=new RK.Vec3;this.rotationAxis.copy(p),l=p.clone(),f=this.pointEnd.clone().sub(this.pointStart),o&&(l.applyQuaternion(h),f.applyQuaternion(this.worldQuaternionStart)),this.rotationAngle=1*f.dot(l.cross(this.eye).normalize())}o?(n.quaternion.copy(this.quaternionStart),n.quaternion.multiply((new RK.Quaternion).setFromAxisAngle(this.rotationAxis,this.rotationAngle))):(n.quaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle),n.quaternion.multiply(this.quaternionStart))}else if("swingTwist"===i){if("X"===e){var w=this.ray.ray.origin,d=this.ray.ray.direction,y=new RK.Vec3;y.subVectors(this.worldPositionStart,w);var m=this.eye.dot(y)/this.eye.dot(d),v=new RK.Vec3;v.copy(d).multiplyScalar(m).add(w),v.sub(this.worldPositionStart);var g=v.length(),b=this.clickPointStart.length(),S=0;if(g<b)S=Math.sqrt(b*b-g*g);else if(g<2*b)g=2*b-Math.min(g,1*b),v.normalize().multiplyScalar(g),S=-Math.sqrt(b*b-g*g);else{var R=g-2*b,K=3*b;g=(1-RK.Math.smoothstep(R,0,K))*b,v.normalize().multiplyScalar(g),S=-Math.sqrt(b*b-g*g)}S*=this.pointZScale;var M=new RK.Vec3(1,0,0),O=new RK.Vec3;O.copy(this.eye).multiplyScalar(S).add(v).applyQuaternion(this.parentQuaternion.clone().inverse()).multiply(this.parentScale).applyQuaternion(this.swingSpaceQuaternion.clone().inverse()).normalize(),this.swingTwist.swing.setFromUnitVectors(M,O),this.swingTwist.toQuaternion(this.object.quaternion)}else if("twist"===e){var k=this._getTwistRayHit();if(this.twistSideOn){var j=new RK.Quaternion,T=k.z,P=((T=Math.min(Math.max(T,-this.radiusStart),this.radiusStart))-this.twistRayHitStart.z)/this.radiusStart*this.parentScale.x;j.setFromAxisAngle(new RK.Vec3(1,0,0),P),this.swingTwist.twist.multiplyQuaternions(j,this.swingTwistStart.twist)}else{var x=new RK.Vec3,Q=new RK.Vec3;x.copy(this.twistRayHit1).normalize(),Q.copy(k).normalize();var C=(new RK.Quaternion).setFromUnitVectors(x,Q),z=this.twistRayHitStart.length(),E=k.length(),V=RK.Math.smoothstep(E,z/2,z),_=2*Math.asin(C.x)*V;this.twist+=_,this.twist=this.clampAngle(this.twist,this.swingTwistLimits.x[0],this.swingTwistLimits.x[1]);var L=new RK.Quaternion;L.setFromAxisAngle(new RK.Vec3(1,0,0),this.twist),this.swingTwist.twist.copy(L),this.twistRayHit1.copy(k)}this.swingTwist.toQuaternion(this.object.quaternion)}this.object.quaternion.premultiply(this.gizmoOrient),this.object.quaternion.premultiply(this.bindQuaternion),this.object.quaternion.multiply(this.gizmoOrientInverse),this.object.quaternion.multiply(this.preRotate),this.coneConstraint&&this.coneConstraint.constrain(this.object)}CK.renderManager.requestShadowUpdate(),this.refresh(),this.dispatchEvent({type:"change",value:!1})}}}},{key:"clampAngle",value:function(t,e,i){var n=(e+i)/2,r=t-n;r/=Math.PI,r-=2*Math.floor(.5*r+.5);var o=n+(r*=Math.PI);return o=Math.min(Math.max(o,e),i)}},{key:"onPointerUp",value:function(t){void 0!==t.button&&0!==t.button||(this.dragging&&null!==this.axis&&(CK.display.sunOcclusion&&(CK.display.sunOcclusion.ignoreNeedsRefreshCount=3),this.dispatchEvent({type:"dragging-changed",value:!1}),this.dispatchEvent({type:"change-finished",value:this.object}),this.refresh()),this.dragging=!1,void 0===t.button&&(this.axis=null))}},{key:"onCameraMoved",value:function(t){this.updateGizmoScale()}},{key:"onScreenResized",value:function(t){this.updateGizmoScale()}},{key:"updateGizmoScale",value:function(){var t=N(RK.Vec3,$(this.camera.matrixWorld.elements.slice(8,11))).multiplyScalar(-1),e=N(RK.Vec3,$(this.camera.matrixWorld.elements.slice(12,15))),i=this.camera.getEffectiveFOV()*Math.PI/180,n=this.camera.aspect,r=this.camera.view,o=r.width/r.fullWidth;i=2*Math.atan(o*Math.tan(i/2));var s=2*this.worldPosition.clone().sub(e).dot(t)*Math.tan(i/2),a=s*n,u=Math.min(a,s),c=(UIState.compact?.225:.14)*u;this.gizmo.gizmoScale=c/.4}},{key:"getPointer",value:function(t){var e=t.changedTouches?t.changedTouches[0]:t,i=this.domElement.getBoundingClientRect(),n=(e.width||(e.radiusX?2*e.radiusX:0)||t.width||(t.radiusX?2*t.radiusX:0)||0)>1.5;return{x:(e.clientX-i.left)/i.width*2-1,y:-(e.clientY-i.top)/i.height*2+1,isTouch:n,button:t.button}}},{key:"_getTwistRayHit",value:function(){var t=new RK.Vec3(1,0,0);t.applyQuaternion(this.twistSpaceQuaternion),this.twistSideOn||(t.multiply(this.parentScale),t.applyQuaternion(this.parentQuaternion));var e=this.ray.ray.origin,i=this.ray.ray.direction,n=new RK.Vec3;n.subVectors(this.worldPositionStart,e);var r=t.dot(n)/t.dot(i),o=new RK.Vec3;return o.copy(i).multiplyScalar(r).add(e),o.sub(this.worldPositionStart),this.twistSideOn||o.applyQuaternion(this.parentQuaternion.clone().inverse()).multiply(this.parentScale),o.applyQuaternion(this.twistSpaceQuaternion.clone().inverse()),o}},{key:"local",get:function(){return"scale"===this.mode||"local"===this.space}}])&&tt(i.prototype,n),r&&tt(i,r),e}();function ot(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t))&&"[object Arguments]"!==Object.prototype.toString.call(t))return;var i=[],n=!0,r=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(n=(s=a.next()).done)&&(i.push(s.value),!e||i.length!==e);n=!0);}catch(t){r=!0,o=t}finally{try{n||null==a.return||a.return()}finally{if(r)throw o}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function st(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function at(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}rt.defaultLimits={x:[-Math.PI,Math.PI],y:[-Math.PI,Math.PI],z:[-Math.PI,Math.PI],order:"swingtwist",orient:{x:0,y:0,z:0,w:1}};var ut=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}var e,i,n;return e=t,n=[{key:"init",value:function(){var t=this;this.initialized||(this.initialized=!0,this.transformer=new rt(CK.orbitCamera.camera,CK.getDomElement()),this.transformer.addEventListener("dragging-changed",(function(t){CK.orbitCamera.controls.enabled=!t.value})),CK.Events.on("CharacterFinishedChanging",(function(){return t.refresh()})),this.transformer.addEventListener("change",(function(){t.previewObjectData(),CK.Events.emit("gizmoOnChange")})),this.transformer.addEventListener("change-finished",(function(){t.updateObjectData(),CK.Events.emit("gizmoAfterChange")})),this.enableSelection&&CK.RenderIDs.init(),this.dom=CK.renderManager.renderer.domElement,this.dom.addEventListener("mouseup",(function(e){return t.onMouseUp(e)}),!1),window.addEventListener("keydown",(function(e){if(t.hotkeys)switch(e.keyCode){case 87:t.setMode("translate");break;case 69:t.setMode("rotate");break;case 82:t.setMode("scale");break;case 46:t.deleteKit();break;case 68:t.copyKit()}})))}},{key:"modeToShort",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getMode();return{translate:"pos",rotate:"rot",scale:"scl",swingTwist:"qtn"}[t]}},{key:"modeToLong",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getMode();return{translate:"position",rotate:"rotation",scale:"scale",swingTwist:"quaternion"}[t]}},{key:"getSelectedObj",value:function(){return this.getSelectedBone()||this.getSelectedMesh()}},{key:"getObjectData",value:function(){var t=this.getSelectedObj(),e=this.getMode();if(t&&("translate"===e||"rotate"===e||"scale"===e||"swingTwist"===e)){var i=this.modeToShort(e),n={pos:t.position,rot:t.rotation,scl:t.scale,qtn:t.quaternion}[i].toSimple(),r={transforms:st({},this.slot,st({},this.boneID||"root",st({},i,n)))};return CK.display.bakeCodePosingIntoTransforms(r.transforms),r}return null}},{key:"updateObjectData",value:function(){var e=t.getObjectData();e&&(CK.tweak(e),CK.Events.emit("transformsChanged"))}},{key:"previewObjectData",value:function(){var e=t.getObjectData();e&&CK.character.previewTransforms(e.transforms)}},{key:"enable",value:function(){this.enabled=!0,this.refresh()}},{key:"disable",value:function(){this.enabled=!1,this.refresh()}},{key:"addPart",value:function(t){var e=this._getAvailableKitID();CK.tweak({kit:st({},e,{id:t})}),this.select(e)}},{key:"deleteKit",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.slot;this.slot===t&&(this.slot=void 0),CK.tweak({kit:st({},t,void 0)}),this.refresh()}},{key:"clearAllKit",value:function(){this.slot=void 0,this.boneID=void 0,CK.tweak({kit:void 0}),this.refresh()}},{key:"copyKit",value:function(){arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.slot;var t=this._getAvailableKitID(),e=CK.data.kit[id]||console.error("Kit not found to copy"),i=CK.Helpers.deepCopy(e);i.pos=i.pos?[i.pos[0]+.03,i.pos[1]+.03,i.pos[2]+.03]:[.03,.03,.03],CK.tweak({kit:st({},t,i)}),this.select(t)}},{key:"deselect",value:function(){this.clearHighlight(),this.boneID=void 0,this.slot=void 0,this.refresh(),CK.Events.emit("kit-selection-changed")}},{key:"select",value:function(t,e){this.clearHighlight(),this.getMode()||this.setMode("translate"),this.boneID=e,this.slot=t,this.getSelectedMesh()&&this.getSelectedBone()||console.error("Invalid select request for",t,e),this.enable(),CK.Events.emit("kit-selection-changed")}},{key:"_getAvailableKitID",value:function(){for(var t=0;t<256;t++)if(!("k_"+t in CK.data.kit))return t;console.error("Max kit limit reached")}},{key:"manipulateSelected",value:function(){var t=this.getSelectedMesh();if(t){var e=this.getSelectedBone();e?this.manipulate(e):t.skeleton?this.manipulate(t.skeleton.obj):this.manipulate(t)}else this.detach()}},{key:"manipulate",value:function(t){this.init(),CK.scene.add(this.transformer),this.transformer.attach(t,this.slot)}},{key:"detach",value:function(){this.transformer&&(this.transformer.detach(),CK.scene.remove(this.transformer))}},{key:"getSelectedMesh",value:function(){if(void 0!==this.slot){var t=CK.display.meshes[this.slot];if(t)return t}}},{key:"getSelectedBone",value:function(){var t=this.getSelectedMesh();if(t&&void 0!==this.boneID)return CK.display.getBoneFromID(t,this.boneID)}},{key:"setMode",value:function(t){this.enable(),this._mode=t,this.refresh()}},{key:"setConeLimit",value:function(t){this.coneLimit=t,this.refresh()}},{key:"setGizmoScale",value:function(t){t=t||1.5,this.gizmoScale!==t&&(this.gizmoScale=t||1.5,this.refresh())}},{key:"getMode",value:function(){return this._mode}},{key:"onMouseUp",value:function(t){if(this.enabled&&!this.transformer.axis&&!CK.orbitCamera.controls.hasMoved&&this.enableSelection){var e=ot(CK.RenderIDs.getID(t.layerX,t.layerY),2),i=e[0],n=e[1];i&&this.select(i,n)}}},{key:"clearHighlight",value:function(){var t=this.getSelectedMesh();t&&t.material&&t.material.setUniform("emissive",new RK.Vec3(0,0,0))}},{key:"refresh",value:function(){var t=this.getMode();if(this.enabled&&t){var e=this.getSelectedMesh();this.init(),this.enableSelection&&CK.RenderIDs.setMode(CK.RenderIDs.modes.OBJECT),e&&e.material&&!this.boneID&&e.material.setUniform("emissive",new RK.Vec3(.1,0,0)),"select"===t?this.detach():"translate"===t||"rotate"===t||"scale"===t||"swingTwist"===t?(this.transformer.setMode(t),this.manipulateSelected()):console.error("Unrecognized mode ",t)}else this.clearHighlight(),this.detach();CK.GameLoop.requestRenderRefresh()}}],(i=null)&&at(e.prototype,i),n&&at(e,n),t}();console.log("EX ".concat("Production 4/12/20 11:14:9 B:release/hf_2020_04_03 V14102")),window.EX={Kit:ut},CK.Events.emit("extras-loaded")}});
//# sourceMappingURL=dev/extras.js.map